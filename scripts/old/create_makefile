#!/bin/sh

# Rainbow, a termination proof certification tool
# See the COPYRIGHTS and LICENSE files.
#
# - Frederic Blanqui, 2009-10-23

prog=`basename $0`

usage () { echo "usage: $prog [-h] prover ext ext2coq [dir]"; }

help () {
  cat <<EOF
Generate a Makefile for running on all the TPDB files of dir (or . if
not set) and all its subdirectories recursively:

- a program 'prover' producing from a file.[trs|srs|xtc] and a timeout:
a file.time for the time taken, a file.out for the result
(YES|NO|MAYBE|KILLED) if there is no error, and a file.ext for
the proof if the result is YES or NO.

- a program 'ext2coq' producing from a file.ext a file.v.

Do 'make' to see the possible targets.

Options:
-h Provide this help and exit
EOF
}

args () { echo 'error: wrong number of arguments'; usage; exit 1; }

case "$1" in
-h) usage; echo; help; exit 0;;
esac

if test $# -lt 3 -o $# -gt 4; then args; fi

prover=$1
ext=$2
ext2coq=$3
dir=${4:-.}

echo 'create Makefile ...'
cat > Makefile <<EOF
# DO NOT EDIT THIS FILE AUTOMATICALLY GENERATED BY:
# $prog '$prover' $ext '$ext2coq' $dir

TRS_FILES := `find $dir -name \*.trs | sed -e 's|^./||' -e 's|\.trs$||' | xargs`
SRS_FILES := `find $dir -name \*.srs | sed -e 's|^./||' -e 's|\.srs$||' | xargs`
XTC_FILES := `find $dir -name \*.xtc | sed -e 's|^./||' -e 's|\.xtc$||' | xargs`
EOF
sed -e "s|__EXT__|$ext|g" \
    -e "s|PROVER :=|PROVER := $prover|g" \
    -e "s|EXT2COQ :=|EXT2COQ := $ext2coq|g" \
    `dirname $0`/Makefile.template >> Makefile
